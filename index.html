<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
    <title>Season 4 - Rankings and copper simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="war-logic.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        body { background: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(51, 65, 85, 0.5); }
        .btn-bldg { background: #1e293b; border: 1px solid #334155; color: #64748b; font-size: 10px; font-weight: 900; }
        .btn-bldg.active { background: #0891b2 !important; border-color: #22d3ee !important; color: white !important; }
        .nav-fixed { position: fixed; bottom: 0; left: 0; right: 0; background: #0f172a; border-top: 1px solid #334155; padding-bottom: env(safe-area-inset-bottom); z-index: 100; }
        .tag-badge { background: rgba(34, 211, 238, 0.1); color: #22d3ee; padding: 2px 4px; border-radius: 4px; font-size: 10px; font-weight: 800; border: 1px solid rgba(34, 211, 238, 0.3); }
        .global-card { border-left: 2px solid #6366f1; background: rgba(99, 102, 241, 0.05); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body x-data="warRoom()" x-init="init()" class="pb-32">

    <!-- HEADER -->
    <header class="sticky top-0 z-[60] glass mx-2 mt-2 p-3 flex justify-between items-center backdrop-blur-xl lg:max-w-[1400px] lg:mx-auto rounded-2xl">
        <div class="flex items-center gap-2">
            <div class="h-8 w-1 bg-red-600 rounded-full"></div>
            <h1 class="text-lg font-black tracking-tighter text-white uppercase italic">Kage faction calculator</h1>
        </div>
        <div class="text-right">
            <p class="text-[9px] font-black text-amber-500 uppercase italic" x-text="displayClock"></p>
            <p class="text-lg font-mono font-black text-white leading-none" x-text="phaseCountdown"></p>
        </div>
    </header>

    <main class="p-3 lg:max-w-[1400px] lg:mx-auto">

        <!-- INTEL HUB -->
        <div x-show="tab === 'warroom'" class="space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                
                <!-- GLOBAL RANKING (NEW) -->
                <div class="lg:col-span-3 space-y-4">
                    <h3 class="text-[10px] font-black uppercase text-indigo-400 px-2 tracking-widest italic underline decoration-2 underline-offset-4">Global Ranking (1-200)</h3>
                    <div class="glass rounded-2xl overflow-hidden max-h-[80vh] overflow-y-auto scrollbar-hide border-indigo-500/20">
                        <template x-for="a in processedAlliances.slice(0, 50)">
                            <div class="p-3 border-b border-slate-800 flex justify-between items-center global-card">
                                <div class="flex items-center gap-3">
                                    <span class="text-[10px] font-black text-indigo-500" x-text="'#' + a.globalRank"></span>
                                    <span class="text-[10px] font-bold text-white uppercase truncate w-24" x-text="a.name"></span>
                                </div>
                                <span class="text-[10px] font-mono font-black text-slate-400" x-text="formatNum(a.stash)"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- FACTION BRACKETS -->
                <div class="lg:col-span-9 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <template x-for="f in ['Kage', 'Koubu']">
                        <div class="space-y-4">
                            <h3 class="text-[10px] font-black uppercase tracking-widest px-2" :class="f === 'Kage' ? 'text-red-500' : 'text-blue-500'" x-text="f + ' Standings'"></h3>
                            <template x-for="g in getGroupedFaction(f)">
                                <div class="space-y-2">
                                    <div @click="openGroups = openGroups.includes(f+g.id) ? openGroups.filter(x=>x!==f+g.id) : [...openGroups, f+g.id]" class="flex justify-between p-3 bg-slate-900 rounded-xl border border-slate-800 cursor-pointer">
                                        <span class="text-[10px] font-black uppercase text-slate-500" x-text="g.label"></span>
                                        <span class="text-slate-600 text-xs" x-text="openGroups.includes(f+g.id) ? '‚ñ≤' : '‚ñº'"></span>
                                    </div>
                                    <div x-show="openGroups.includes(f+g.id)" class="grid grid-cols-1 gap-2">
                                        <template x-for="a in g.alliances">
                                            <div @click="toggleAlliancePlayers(a.id)" class="glass p-3 rounded-xl border-l-4 cursor-pointer" :class="f === 'Kage' ? 'border-red-600' : 'border-blue-600'">
                                                <div class="flex justify-between items-center">
                                                    <div class="flex items-center gap-2">
                                                        <span class="tag-badge" x-text="a.tag"></span>
                                                        <h4 class="text-xs font-black text-white uppercase truncate w-24" x-text="a.name"></h4>
                                                    </div>
                                                    <p class="text-xs font-mono font-black text-white" x-text="formatNum(a.stash)"></p>
                                                </div>
                                                <div x-show="alliancePlayers[a.id]" class="mt-3 pt-3 border-t border-slate-800 space-y-1">
                                                    <template x-for="p in alliancePlayers[a.id]">
                                                        <div class="flex justify-between text-[10px] font-mono"><span class="text-slate-400 uppercase" x-text="p.name"></span><span class="text-cyan-400 font-bold" x-text="formatNum(p.thp)"></span></div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- PLANNER TAB -->
        <div x-show="tab === 'sim'" class="space-y-4" x-cloak>
            <div class="glass p-6 rounded-2xl flex flex-col lg:flex-row gap-6">
                <!-- RANGE PICKER & EXPLANATION -->
                <div class="flex-1 space-y-3">
                    <h2 class="text-xl font-black text-white uppercase italic tracking-tighter underline decoration-red-600">Battle Command</h2>
                    <div class="bg-black/40 p-4 rounded-xl border border-slate-800">
                        <!-- USER EXPLANATION TEXT BOX -->
                        <p class="text-xs text-slate-400 leading-relaxed italic">
                            [Select the range of alliances you want to simulate the outcome off. This planner simulates the outcome, you can decide how many buildings you expect the alliance to plunder. 
                            Select opponents to calculate stolen copper. Press Simulate to see how these transfers 
                            will affect the rankings and global standing for the next round.]
                        </p>
                    </div>
                </div>
                <div class="lg:w-72 space-y-4">
                    <div class="bg-slate-900 p-4 rounded-xl border border-slate-800">
                        <p class="text-[10px] font-black text-slate-500 uppercase mb-2">Simulation Range</p>
                        <div class="flex items-center gap-2">
                            <input type="number" x-model="simRange.start" class="w-full bg-black p-2 text-xs text-center border border-slate-800 rounded text-white">
                            <span class="text-slate-600">-</span>
                            <input type="number" x-model="simRange.end" class="w-full bg-black p-2 text-xs text-center border border-slate-800 rounded text-white">
                        </div>
                        <button @click="setupPlanner()" class="w-full bg-red-600 mt-3 py-2 rounded-lg text-[10px] font-black uppercase">Load Range</button>
                    </div>
                    <button @click="runSimulation()" class="w-full bg-emerald-600 py-4 rounded-xl font-black uppercase shadow-lg shadow-emerald-900/20">üöÄ Run Simulation</button>
                </div>
            </div>
            
            <template x-for="(match, idx) in planner">
                <div class="glass p-4 rounded-xl border-l-4 border-red-600 grid grid-cols-1 lg:grid-cols-12 gap-3 items-center">
                    <div class="lg:col-span-3 flex items-center gap-2">
                        <span class="text-[10px] font-black text-slate-600" x-text="'#'+match.kage.liveRank"></span>
                        <span class="tag-badge" x-text="match.kage.tag"></span>
                        <span class="text-xs font-bold text-white truncate" x-text="match.kage.name"></span>
                    </div>
                    <div class="lg:col-span-4">
                        <select x-model="match.targetId" @change="calculateMatch(idx)" class="w-full bg-slate-950 border border-slate-800 p-2 rounded text-[10px] text-white">
                            <option value="">Select Koubu Target...</option>
                            <template x-for="t in processedAlliances.filter(x=>(x.faction||'').includes('Koubu')).sort((x,y)=>x.liveRank-y.liveRank)">
                                <option :value="t.id" x-text="'['+t.tag+'] '+t.name + ' (#'+t.liveRank+')'"></option>
                            </template>
                        </select>
                    </div>
                    <div class="lg:col-span-3 flex gap-1">
                        <template x-for="i in [0,1,2,3]"><button @click="toggleBuilding(idx, i)" :class="match.buildings.includes(i) ? 'active' : ''" class="btn-bldg w-8 h-8 rounded-lg" x-text="i < 3 ? 'W' : 'C'"></button></template>
                        <button @click="setZero(idx)" :class="planner[idx].isZero ? 'bg-red-600 text-white' : 'bg-slate-800 text-slate-500'" class="w-10 h-8 rounded-lg text-[8px] font-black ml-2">ZERO</button>
                    </div>
                    <div class="lg:col-span-2 text-right"><p class="text-xs font-mono font-black text-emerald-400" x-text="formatNum(match.estStolen)"></p></div>
                </div>
            </template>
        </div>

        <!-- RESULTS TAB -->
        <div x-show="tab === 'results'" class="space-y-6" x-cloak>
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-black text-white uppercase italic tracking-tighter">Simulated Ranking</h2>
                <button @click="tab='sim'" class="bg-slate-800 px-4 py-2 rounded text-[10px] font-black uppercase text-white">‚Üê Edit Plan</button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- GLOBAL SIM RANKING -->
                <div class="lg:col-span-3 space-y-4">
                    <h3 class="text-xs font-black uppercase text-indigo-400 px-2 tracking-widest italic">Global Sim Ranking</h3>
                    <div class="glass rounded-2xl max-h-[70vh] overflow-y-auto scrollbar-hide">
                        <template x-for="a in simAlliances.slice(0, 50)">
                            <div class="p-3 border-b border-slate-800 flex justify-between items-center" :class="a.faction.includes('Kage') ? 'border-l-2 border-red-500' : 'border-l-2 border-blue-500'">
                                <span class="text-[10px] font-black text-white" x-text="'#'+a.globalSimRank"></span>
                                <span class="text-[10px] font-bold text-slate-300 uppercase truncate w-24" x-text="a.name"></span>
                                <p class="text-[10px] font-mono font-black text-white" x-text="formatNum(a.simStash)"></p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- FACTION SIM RANKING -->
                <div class="lg:col-span-9 grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <template x-for="f in ['Kage', 'Koubu']">
                        <div class="space-y-4">
                            <h3 class="text-xs font-black uppercase text-slate-500 px-2 tracking-widest" x-text="f + ' Projected Groups'"></h3>
                            <template x-for="g in getGroupedFaction(f, simAlliances)">
                                <div class="space-y-2">
                                    <div class="p-2 bg-slate-900/40 rounded-lg text-[10px] font-black text-slate-600 uppercase" x-text="g.label"></div>
                                    <template x-for="a in g.alliances">
                                        <div class="glass p-3 rounded-xl flex justify-between items-center">
                                            <div class="flex items-center gap-3">
                                                <span class="text-[10px] font-black text-white" x-text="'#'+a.factionRank"></span>
                                                <span class="tag-badge" x-text="a.tag"></span>
                                                <span class="text-xs font-bold text-slate-300" x-text="a.name"></span>
                                            </div>
                                            <p class="text-xs font-mono font-black text-white" x-text="formatNum(a.simStash)"></p>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>

    </main>

    <!-- NAVIGATION -->
    <nav class="nav-fixed flex justify-around p-4">
        <button @click="tab='warroom'" :class="tab==='warroom'?'text-cyan-400':'text-slate-600'" class="flex flex-col items-center gap-1">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span class="text-[8px] font-black uppercase">Intel</span>
        </button>
        <button @click="tab='sim'" :class="tab==='sim'?'text-red-500':'text-slate-600'" class="flex flex-col items-center gap-1">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M21 3L3 10.53v.98l7.51 3.22L13.74 22h.98L22 3.5 21 3z"/></svg>
            <span class="text-[8px] font-black uppercase">Command</span>
        </button>
    </nav>
</body>
</html>
